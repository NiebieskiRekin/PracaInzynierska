
\chapter{Architektura systemu}

PrzyjÄ™te ograniczenia:
- tani w utrzymaniu dÅ‚ugoterminowym, najlepiej bezpÅ‚atny
- niewielki narzut czasowy na operacje podtrzymania, moÅ¼liwie prosty
- wystarczajÄ…co wydajny, by zapewniÄ‡ dostÄ™p dla max 400 uÅ¼ytkownikÃ³w (100 w danym momencie czasu) do tej samej bazy danych
- bezpieczny, bazujÄ…cy na rozwiÄ…zaniach open-source i modularny, uÅ‚atwiajÄ…c migracjÄ™ i zmniejszajÄ…c moÅ¼liwy obszar naduÅ¼yÄ‡ w przypadku naruszenia bezpieczeÅ„stwa
- oferuje przyjazny i intuicyjny interfejs graficzny do uÅ¼ycia w przeglÄ…darce na komputerze oraz w postaci aplikacji mobilnej PWA

---

Ze wzglÄ™du na specyfikÄ™ aplikacji umoÅ¼liwiajÄ…cÄ… edycjÄ™ danych dotyczÄ…cych danej hodowli koni wielu uÅ¼ytkownikom, w szczegÃ³lnoÅ›ci korzystajÄ…cych w wiÄ™kszoÅ›ci z urzÄ…dzeÅ„ mobilnych oraz sporadycznie z komputerÃ³w osobistych, zdecydowano siÄ™ na formÄ™ systemu webowego z interfejsem uÅ¼ytkownika dostÄ™pnym w przeglÄ…darce. DostÄ™p do usÅ‚ugi z wykorzystaniem przeglÄ…darki do wyÅ›wieltania interfejsu uÅ¼ytkownika pozwala na wykorzystanie bogatego i dojrzaÅ‚ego zaplecza technologicznego do wyÅ›wietlania stron internetowych, znaczÄ…co upraszcza aspekt dystrybucji oprogramowania oraz wspÃ³Å‚czesnego dostÄ™pu do danych. 
KorzystajÄ…c z technologii progresywnych aplikacji internetowych (ang. Progressive Web App, PWA) oraz praktyki responsywnego projektowania stron internetowych (ang. responsive web design, RWD) zaimplementowano spÃ³jny interfejs uÅ¼ytkownika dla platform mobilnych. Do implementacji technologii progresywnych aplikacji internetowych wymagane jest, aby interfejs graficzny uÅ¼ytkownika byÅ‚ skomponowany w zdecydowanej wiÄ™kszoÅ›ci ze statycznych (podlegajÄ…cych nieczÄ™stym zmianom i niezmienialnych) dokumentÃ³w hipertekstowych HTML (HyperText Markup Language), arkuszy stylÃ³w CSS (Cascading Style Sheets) oraz kodu w jÄ™zyku programowania Javascript. Dla zachowania kompatybilnoÅ›ci z technologiÄ… progresywnych aplikacji internetowych oraz modularnoÅ›ci zdecydowano siÄ™ na rozdzielenie ich na osobne procesy. 

---

Frontend:
Framework React Router
- czemu: prosty, lekki, pozwala na Å‚atwy client-side rendering
- korzysta z: React, Typescript, Vite, Nginx
- Dodatki: VitePWA, Zod, Tailwind
- opis: multi-strategy router for React bridging the gap from React 18 to React 19. You can use it maximally as a React framework or as minimally as you want

czemu React:
czemu:
- popularny, prosty, znany przez zespÃ³Å‚
opis: React is a JavaScript library for building user interfaces.

    Declarative: React makes it painless to create interactive UIs. Design simple views for each state in your application, and React will efficiently update and render just the right components when your data changes. Declarative views make your code more predictable, simpler to understand, and easier to debug.
    Component-Based: Build encapsulated components that manage their own state, then compose them to make complex UIs. Since component logic is written in JavaScript instead of templates, you can easily pass rich data through your app and keep the state out of the DOM.
    Learn Once, Write Anywhere: We don't make assumptions about the rest of your technology stack, so you can develop new features in React without rewriting existing code. React can also render on the server using Node and power mobile apps using React Native.


Typescript:
czemu
- uzupeÅ‚nia Javascript o brakujÄ…ce elementy (typy)
- poprawia jakoÅ›Ä‡ kodu
opis: TypeScript is a strongly typed programming language that builds on JavaScript, giving you better tooling at any scale


Vite:
opis: a build tool that aims to provide a faster and leaner development experience for modern web projects. It consists of two major parts:

    A dev server that provides rich feature enhancements over native ES modules, for example extremely fast Hot Module Replacement (HMR).

    A build command that bundles your code with Rollup, pre-configured to output highly optimized static assets for production.
czemu:
- poprawia wydajnoÅ›Ä‡ stron
- uÅ‚atwia ich przygotowania do wdroÅ¼enia
- zapewnia PWA wraz z pluginem VitePWA

Zod:
opis:
Zod is a TypeScript-first validation library. Using Zod, you can define schemas you can use to validate data
czemu:
    Walidacja danych po obu stronach z jednakowym schematem, bogaty system obsÅ‚ugi bÅ‚Ä™dÃ³w i integracje
    Zero external dependencies
    Works in Node.js and all modern browsers
    Tiny: 2kb core bundle (gzipped)
    Immutable API: methods return a new instance
    Concise interface
    Works with TypeScript and plain JS
    Built-in JSON Schema conversion
    Extensive ecosystem

Nginx:
opis: an HTTP web server, reverse proxy, content cache, load balancer, TCP/UDP proxy server, and mail proxy server
czemu:
- wykorzystywany tylko HTTP web serwer
- wydajny i maÅ‚y rozmiar instalacji
- bardzo bogaty w funkcje
- dobrze znany


---

Backend:

Hono:
opis: Web application framework. Fast, lightweight, built on Web Standards. Support for any JavaScript runtime.
czemu: 
Ultrafast ğŸš€ - The router RegExpRouter is really fast. Not using linear loops. Fast.
Lightweight ğŸª¶ - The hono/tiny preset is under 14kB. Hono has zero dependencies and uses only the Web Standards.
Multi-runtime ğŸŒ - Works on Cloudflare Workers, Fastly Compute, Deno, Bun, AWS Lambda, or Node.js. The same code runs on all platforms.
Batteries Included ğŸ”‹ - Hono has built-in middleware, custom middleware, third-party middleware, and helpers. Batteries included.
Delightful DX ğŸ˜ƒ - Super clean APIs. First-class TypeScript support. Now, we've got "Types"

Hono is a simple web application framework similar to Express, without a frontend. But it runs on CDN Edges and allows you to construct larger applications when combined with middleware. Here are some examples of use-cases.

    Building Web APIs

czemu:
- prosty framework w typescipt do tworzenia api,
- szybki do nauczenia siÄ™,
- dziaÅ‚a szybko i ma maÅ‚e zuÅ¼ycie zasobÃ³w
- czemu backend w js? aby uÅ¼ywaÄ‡ tego samego modelu danych i komunikacji z frontendem za pomocÄ… hono RPC

Zod: jak we frontendzie, dodatkowo Å‚adnie integruje siÄ™ z adapterem do bazy danych Drizzle i odpowiada za definicje schematÃ³w OpenAPI


DrizzleORM: 
(opis tego bÄ™dzie trudny) ORM with both relational and SQL-like query APIs. Pozwala na zdefiniowanie tabel i relacji kompatybilnych z Zod i typami w Typescript, a nastÄ™pnie uÅ¼ywaÄ‡ API bliÅºniaczego do czystego SQL z minimalnym narzutem. Dodatkowo dostarcza narzÄ™dzia uÅ‚atwiajÄ…ce zarzÄ…dzanie poÅ‚Ä…czeniem, migracjami oraz udostÄ™pnia niskopoziomowe optymalizacje bezpoÅ›rednio do Typescript zapobiegajÄ…c SQL injection

Node mailer - wysyÅ‚ka maili jako powiadomienia i do raportÃ³w, korzysta z Gmail SMTP
google-cloud/storage - do obsÅ‚ugi Google cloud storage (odpowiednika S3) i przechowywania zdjÄ™Ä‡ - pozwala to uniknÄ…Ä‡ wysokich opÅ‚at za ruch sieciowy egress, zapewnia lepszÄ… izolacjÄ™ Å›rodowisk, prostsze udostÄ™pnianie danych, mniejsze obciÄ…Å¼enie serwera
google/generative-ai - do poÅ‚Ä…czenia z Gemini LLM poprzez API, sÅ‚uÅ¼y do przetwarzania jÄ™zyka naturalnego i wyciÄ…gania intencji uÅ¼ytkownika do pÃ³Åºniejszej konwersji na akcje na API (TODO: koniecznie bardziej opisaÄ‡)
hono/swagger-ui, hono/zod-openapi, zod-openapi, hono-openapi - konwersja routes hono do schematu openapi, wykorzystywane przez nasz klasyfikator i gemini do uzyskania informacji o moÅ¼liwoÅ›ciach naszego backendu
node-cron - zadania okresowe
winston - logi
bcrypt - hashowanie haseÅ‚
dotenv - odczyt sekretÃ³w z pliku .env

---

Przechowywanie danych

postgres - relacyjna baza danych SQL, szybka, uniwersalna, prosta
zapis do dedykowanej partycji - zapewnienie, Å¼e braki miejsca na dysku w danej partycji nie spowodujÄ… bÅ‚Ä™dÃ³w w innej, osobne IOPS, backupy (pgdump) dla uproszczenia na innej partycji

borgmatic - program owijajÄ…cy pgdump o wiele przydatnych funkcji takich jak rotowanie backupÃ³w (np. max 5 z 3 miesiÄ™cy), progresywnÄ… kompresjÄ™ z uÅ¼yciem borgbackup , automatyczne zadania, integracje z ansible, ntfy.sh, nic poza bazÄ… nie jest backupowane, gdyÅ¼ z zaÅ‚oÅ¼enia jest odtwarzalne z kodu 

borgbackup - deduplicating backup program. Optionally, it supports compression and authenticated encryption.


---

Klasyfikator

Transformator dziaÅ‚ajÄ…cy na osadzaniach sÅ‚Ã³w w celu wydobycia informacji o moÅ¼liwym wykorzystywanym API endpoint dla wybranych zapytaÅ„ dodawania danych.

Zrobiony jako osobny moduÅ‚, ze wzglÄ™du na zupeÅ‚nie oddzielny zestaw zaleÅ¼noÅ›ci.

Wykorzystywane:
sentence-transformers - operacje na osadzeniach sÅ‚Ã³w
scikit-learn - podziaÅ‚ zbioru danych i inne operacje czÄ™sto wykorzystywane w uczeniu maszynowym
numpy, torch - operacje na wektorach i macierzach
fastapi - wystawienie REST API
pydantic, typing - wzbogacenie dynamicznego Pythona o deklaracje typÃ³w
uv - zarzÄ…dzanie zaleÅ¼noÅ›ciami i Å›rodowiskiem wykonawczym

---

PrzepÅ‚yw ruchu sieciowego od uÅ¼ytkownikÃ³w koÅ„cowych:

UÅ¼ytkownik Å‚Ä…czÄ…c siÄ™ z serwerem DNS i pytajÄ…c o nazwÄ™ domenowÄ… naszej strony otrzymuje adres serwera Cloudflare, ktÃ³ry sÅ‚uÅ¼y do filtrowania niechcianego ruchu sieciowego (Web Application Firewall).
NastÄ™pnie ruch jest przekazywany dalej do podsieci naszego serwera w Google Cloud Platform. Jest tam filtrowany przez firewall, ktÃ³ry zezwala na ruch tylko na okreÅ›lonych portach i dodatkowo ogranicza naduÅ¼ycia.
Co idzie dalej, do instancji serwera dziaÅ‚ajÄ…cego jako VMka na Google Cloud Platform dociera zapytanie od klienta. Jest ono interpretowane i przetwarzane przez Traefik pod wzglÄ™dem poprawnoÅ›ci i w razie pomyÅ›lnej interpretacji przekazywane do usÅ‚ugi downstream.
domyÅ›lnie zapytania (/) idÄ… do frontendu, aby wyÅ›wietliÄ‡ interfejs uÅ¼ytkownika
/klasyfikator obsÅ‚uguje api klasyfikatora intencji 
/api obsÅ‚uguje backend aplikacji

Traefik - wykorzystywany jako HTTP reverse proxy
- pozwala na scentralizowanie wszystkich usÅ‚ug pod jednÄ… domenÄ… i korzystanie ze Å›cieÅ¼ek zamiast portÃ³w
- automatyzuje pozyskiwanie zaufanych certyfikatÃ³w TLS do HTTPS dziÄ™ki Let's Encrypt (zewnÄ™trzna usÅ‚uga publiczna)
- izoluje usÅ‚ugi za proxy przed bezpoÅ›rednim ruchem zewnÄ™trznym i daje wiÄ™cej moÅ¼liwoÅ›ci w kwestii skalowalnoÅ›ci, ma moÅ¼liwoÅ›Ä‡ rozszerzenia o filtry bazujÄ…ce na zaufaniu

Frontend na tym etapie to zwykÅ‚y serwer HTTP nginx, skonfigurowany do serwowania statycznych plikÃ³w HTML, CSS i JS, ktÃ³re sÄ… renderowane po stronie klienta.

Klasyfikator przetwarza Å¼adanie na podstawie lokalnych danych i zwraca wynik.

Najciekawiej jest na backendzie. Po uwierzytelnieniu uÅ¼ytkownika za pomocÄ… dopasowania hashy danych uwierzytelniajÄ…cych do znajdujÄ…cych siÄ™ w bazie danych i wygenerowaniu 2 tokenÃ³w JWT (krÃ³tkotrwaÅ‚ego tokenu sesji oraz dÅ‚ugotrwaÅ‚ego tokenu odÅ›wieÅ¼enia poÅ›wiadczeÅ„) zapytania mogÄ… byÄ‡ kontynuowane. WiÄ™kszoÅ›Ä‡ zapytaÅ„ dotyczy wyÅ›wietlenia lub modyfikacji danych, co za tym idzie nasze Å¼Ä…danie REST HTTP jest mapowane na odpowiednie zapytanie SQL do bazy danych PostgreSQL z uÅ¼yciem adaptera DrizzleORM. W przypadku listingu i wyÅ›wietlania szczegÃ³Å‚Ã³w koni sÄ… pokazywane ich zdjÄ™cia, ktÃ³re sÄ… przechowywane i udostÄ™pniane przez Cloud Storage Bucket. Aby to siÄ™ jednak staÅ‚o musi zostaÄ‡ wygenerowany specjalny link tzw. signed URL, ktÃ³ry jest unikalnym odniesieniem do danego obiektu dla tego uÅ¼ytkownika w tej sesji. Dodatkowo backend obsÅ‚uguje rÃ³wnieÅ¼ komunikacjÄ™ z agentem LLM Gemini do zapytaÅ„ o intencje operacji wstawienia skomponowanych w formie zapytaÅ„ jÄ™zyka naturalnego od uÅ¼ytkownika (backend proxuje zapytania do gemini). Finalnie backend wysyÅ‚a maile Å‚Ä…czÄ…c siÄ™ z serwerem Google SMTP.

---

PowtarzalnoÅ›Ä‡ i izolacja Å›rodowika uruchomieniowego z Docker

Komponenty tworzÄ…ce aplikacjÄ™ (frontend, backend, klasyfikator, baza danych, reverse proxy) korzystajÄ… z instalacji na serwerze za pomocÄ… Å›rodowiska uruchomieniowego Docker. 

TODO:
- opisz czym sÄ… kontenery i ich zalety
- opisz powtarzalnoÅ›Ä‡ i warstwy, uproszczenie wdroÅ¼enia przy zachowaniu maÅ‚ego rozmiaru paczki i zuÅ¼ycia zasobÃ³w
- opisz ich uÅ¼ycie w projekcie, tworzenie obrazÃ³w na podstawie monorepo, optymalizacja i izolacja zaleÅ¼noÅ›ci, distroless


Docker container image is a lightweight, standalone, executable package of software that includes everything needed to run an application: code, runtime, system tools, system libraries and settings.
Container images become containers at runtime and in the case of Docker containers â€“ images become containers when they run on Docker Engine. Available for both Linux and Windows-based applications, containerized software will always run the same, regardless of the infrastructure. Containers isolate software from its environment and ensure that it works uniformly despite differences for instance between development and staging.
Docker containers that run on Docker Engine:
Standard: Docker created the industry standard for containers, so they could be portable anywhere
Lightweight: Containers share the machineâ€™s OS system kernel and therefore do not require an OS per application, driving higher server efficiencies and reducing server and licensing costs
Secure: Applications are safer in containers and Docker provides the strongest default isolation capabilities in the industry 

---

Definicja powtarzalnej infrastruktury aplikacji w kodzie

TODO:
- Terraform jako Day 0 provisioning, konfiguracja VMki, bucketÃ³w GCS, dyskÃ³w wirtualnych, firewalla i systemu operacyjnego
- Ansible jako Day 1-2 provisioning, konfiguracja usÅ‚ug dziaÅ‚ajÄ…cych w systemie, zaleÅ¼noÅ›ci takich jak silnik docker czy borgmatic

---


Automatyzacja potoku ciÄ…gÅ‚ego wdroÅ¼enia metodÄ… push

KaÅ¼de wypchniÄ™cie zmian powoduje uruchomienie potoku do kompilacji kodu typescript i budowania paczek dystrybucji. Te przygotowane paczki po walidacji sÄ… pakowane w zminimalizowane obrazy Docker, a nastÄ™pnie publikowane do registry. NastÄ™pne zadanie wymusza pobranie na maszynÄ™ wirtualnÄ… obrazÃ³w Dockera z rejestru, aktualizacjÄ™ sekretÃ³w oraz pobranie innych dodatkowych plikÃ³w konfiguracyjnych z repozytorium, a nastÄ™pnie restartuje aplikacjÄ™.

Ansible
Github Actions

--- 


MoÅ¼liwa lista tematÃ³w:
- (INFRA) opis infrastruktury: konfiguracja ~sprzÄ™towa vmki, dyskÃ³w, bucketÃ³w z uzyciem terraform, przygotowanie zaleÅ¼noÅ›ci i ustawieÅ„ systemu operacyjnego z ansible, modularnoÅ›Ä‡ i powtarzalnoÅ›Ä‡ Å›rodowiska uruchomieniowego z docker
- (NET) opis ruchu sieciowego end2end: dns i waf z cloudflare, reverse proxy traefik, firewall, podziaÅ‚ frontend - backend, komunikacja backchannel z zewnÄ™trznymi usÅ‚ugami (certy, mail, gemini), optymalizacja dostarczania z optimistic caching i pwa
- (GIT) opis dziaÅ‚ania potokÃ³w ciÄ…gÅ‚ej integracji / ciÄ…gÅ‚ego wdraÅ¼ania z ansible i github actions, hostowanie repozytorium git monorepo, model wspÃ³Å‚pracy nad kodem pull request i weryfikacja jakoÅ›ci kodu z eslint i etapem kompilacji 
- (DATA) opis modelu danych i sposobu ich przechowywania, schemat bazy danych, gÅ‚Ã³wne rodzaje zapytaÅ„, zapewnienia spÃ³jnoÅ›ci danych, sposÃ³b backupu, wspÃ³Å‚dzielony model walidacji danych zod
- (INNE) ciekawe zagadnienia architektury: modularnoÅ›Ä‡ za pomocÄ… mikro usÅ‚ug, wspÃ³Å‚dzielenie schematu danych i dostÄ™pnych funkcji API za pomocÄ… RPC, optymalizacja kosztÃ³w staÅ‚ych do zera za wyjÄ…tkiem dns


---


Referencje:
- PWA:
  1. https://web.dev/explore/progressive-web-apps?hl=pl
  2. https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps
- RWD:
   1. https://developer.mozilla.org/en-US/docs/Learn_web_development/Core/CSS_layout/Responsive_Design
- HTML, CSS, JS
    1. https://pl.wikipedia.org/wiki/HTML
    2. https://pl.wikipedia.org/wiki/Kaskadowe_arkusze_styl%C3%B3w

- React: https://react.dev/
- React Router: https://reactrouter.com/home
- Typescript: https://www.typescriptlang.org/
- Vite: https://vite.dev/
- Zod: https://zod.dev/
- Nginx: https://nginx.org/
- Nginx chainguard (distroless): https://images.chainguard.dev/directory/image/nginx/overview
- Hono: https://hono.dev/
- DrizzleORM: https://orm.drizzle.team/
- Borgmatic: https://torsion.org/borgmatic/
- Borgbackup: https://borgbackup.readthedocs.io/en/stable/
- Traefik: https://doc.traefik.io/traefik/
- Docker: https://www.docker.com/


