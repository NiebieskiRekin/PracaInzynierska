
\chapter{Architektura systemu}

Przyjte ograniczenia:
- tani w utrzymaniu dugoterminowym, najlepiej bezpatny
- niewielki narzut czasowy na operacje podtrzymania, mo偶liwie prosty
- wystarczajco wydajny, by zapewni dostp dla max 400 u偶ytkownik贸w (100 w danym momencie czasu) do tej samej bazy danych
- bezpieczny, bazujcy na rozwizaniach open-source i modularny, uatwiajc migracj i zmniejszajc mo偶liwy obszar nadu偶y w przypadku naruszenia bezpieczestwa
- oferuje przyjazny i intuicyjny interfejs graficzny do u偶ycia w przegldarce na komputerze oraz w postaci aplikacji mobilnej PWA

---

Ze wzgldu na specyfik aplikacji umo偶liwiajc edycj danych dotyczcych danej hodowli koni wielu u偶ytkownikom, w szczeg贸lnoci korzystajcych w wikszoci z urzdze mobilnych oraz sporadycznie z komputer贸w osobistych, zdecydowano si na form systemu webowego z interfejsem u偶ytkownika dostpnym w przegldarce. Dostp do usugi z wykorzystaniem przegldarki do wywieltania interfejsu u偶ytkownika pozwala na wykorzystanie bogatego i dojrzaego zaplecza technologicznego do wywietlania stron internetowych, znaczco upraszcza aspekt dystrybucji oprogramowania oraz wsp贸czesnego dostpu do danych. 
Korzystajc z technologii progresywnych aplikacji internetowych (ang. Progressive Web App, PWA) oraz praktyki responsywnego projektowania stron internetowych (ang. responsive web design, RWD) zaimplementowano sp贸jny interfejs u偶ytkownika dla platform mobilnych. Do implementacji technologii progresywnych aplikacji internetowych wymagane jest, aby interfejs graficzny u偶ytkownika by skomponowany w zdecydowanej wikszoci ze statycznych (podlegajcych nieczstym zmianom i niezmienialnych) dokument贸w hipertekstowych HTML (HyperText Markup Language), arkuszy styl贸w CSS (Cascading Style Sheets) oraz kodu w jzyku programowania Javascript. Dla zachowania kompatybilnoci z technologi progresywnych aplikacji internetowych oraz modularnoci zdecydowano si na rozdzielenie ich na osobne procesy. 

---

Frontend:
Framework React Router
- czemu: prosty, lekki, pozwala na atwy client-side rendering
- korzysta z: React, Typescript, Vite, Nginx
- Dodatki: VitePWA, Zod, Tailwind
- opis: multi-strategy router for React bridging the gap from React 18 to React 19. You can use it maximally as a React framework or as minimally as you want

czemu React:
czemu:
- popularny, prosty, znany przez zesp贸
opis: React is a JavaScript library for building user interfaces.

    Declarative: React makes it painless to create interactive UIs. Design simple views for each state in your application, and React will efficiently update and render just the right components when your data changes. Declarative views make your code more predictable, simpler to understand, and easier to debug.
    Component-Based: Build encapsulated components that manage their own state, then compose them to make complex UIs. Since component logic is written in JavaScript instead of templates, you can easily pass rich data through your app and keep the state out of the DOM.
    Learn Once, Write Anywhere: We don't make assumptions about the rest of your technology stack, so you can develop new features in React without rewriting existing code. React can also render on the server using Node and power mobile apps using React Native.


Typescript:
czemu
- uzupenia Javascript o brakujce elementy (typy)
- poprawia jako kodu
opis: TypeScript is a strongly typed programming language that builds on JavaScript, giving you better tooling at any scale


Vite:
opis: a build tool that aims to provide a faster and leaner development experience for modern web projects. It consists of two major parts:

    A dev server that provides rich feature enhancements over native ES modules, for example extremely fast Hot Module Replacement (HMR).

    A build command that bundles your code with Rollup, pre-configured to output highly optimized static assets for production.
czemu:
- poprawia wydajno stron
- uatwia ich przygotowania do wdro偶enia
- zapewnia PWA wraz z pluginem VitePWA

Zod:
opis:
Zod is a TypeScript-first validation library. Using Zod, you can define schemas you can use to validate data
czemu:
    Walidacja danych po obu stronach z jednakowym schematem, bogaty system obsugi bd贸w i integracje
    Zero external dependencies
    Works in Node.js and all modern browsers
    Tiny: 2kb core bundle (gzipped)
    Immutable API: methods return a new instance
    Concise interface
    Works with TypeScript and plain JS
    Built-in JSON Schema conversion
    Extensive ecosystem

Nginx:
opis: an HTTP web server, reverse proxy, content cache, load balancer, TCP/UDP proxy server, and mail proxy server
czemu:
- wykorzystywany tylko HTTP web serwer
- wydajny i may rozmiar instalacji
- bardzo bogaty w funkcje
- dobrze znany


---

Backend:

Hono:
opis: Web application framework. Fast, lightweight, built on Web Standards. Support for any JavaScript runtime.
czemu: 
Ultrafast  - The router RegExpRouter is really fast. Not using linear loops. Fast.
Lightweight  - The hono/tiny preset is under 14kB. Hono has zero dependencies and uses only the Web Standards.
Multi-runtime  - Works on Cloudflare Workers, Fastly Compute, Deno, Bun, AWS Lambda, or Node.js. The same code runs on all platforms.
Batteries Included  - Hono has built-in middleware, custom middleware, third-party middleware, and helpers. Batteries included.
Delightful DX  - Super clean APIs. First-class TypeScript support. Now, we've got "Types"

Hono is a simple web application framework similar to Express, without a frontend. But it runs on CDN Edges and allows you to construct larger applications when combined with middleware. Here are some examples of use-cases.

    Building Web APIs

czemu:
- prosty framework w typescipt do tworzenia api,
- szybki do nauczenia si,
- dziaa szybko i ma mae zu偶ycie zasob贸w
- czemu backend w js? aby u偶ywa tego samego modelu danych i komunikacji z frontendem za pomoc hono RPC

Zod: jak we frontendzie, dodatkowo adnie integruje si z adapterem do bazy danych Drizzle i odpowiada za definicje schemat贸w OpenAPI


DrizzleORM: 
(opis tego bdzie trudny) ORM with both relational and SQL-like query APIs. Pozwala na zdefiniowanie tabel i relacji kompatybilnych z Zod i typami w Typescript, a nastpnie u偶ywa API bli藕niaczego do czystego SQL z minimalnym narzutem. Dodatkowo dostarcza narzdzia uatwiajce zarzdzanie poczeniem, migracjami oraz udostpnia niskopoziomowe optymalizacje bezporednio do Typescript zapobiegajc SQL injection

Node mailer - wysyka maili jako powiadomienia i do raport贸w, korzysta z Gmail SMTP
google-cloud/storage - do obsugi Google cloud storage (odpowiednika S3) i przechowywania zdj - pozwala to unikn wysokich opat za ruch sieciowy egress, zapewnia lepsz izolacj rodowisk, prostsze udostpnianie danych, mniejsze obci偶enie serwera
google/generative-ai - do poczenia z Gemini LLM poprzez API, su偶y do przetwarzania jzyka naturalnego i wycigania intencji u偶ytkownika do p贸藕niejszej konwersji na akcje na API (TODO: koniecznie bardziej opisa)
hono/swagger-ui, hono/zod-openapi, zod-openapi, hono-openapi - konwersja routes hono do schematu openapi, wykorzystywane przez nasz klasyfikator i gemini do uzyskania informacji o mo偶liwociach naszego backendu
node-cron - zadania okresowe
winston - logi
bcrypt - hashowanie hase
dotenv - odczyt sekret贸w z pliku .env

---

Przechowywanie danych

postgres - relacyjna baza danych SQL, szybka, uniwersalna, prosta
zapis do dedykowanej partycji - zapewnienie, 偶e braki miejsca na dysku w danej partycji nie spowoduj bd贸w w innej, osobne IOPS, backupy (pgdump) dla uproszczenia na innej partycji

borgmatic - program owijajcy pgdump o wiele przydatnych funkcji takich jak rotowanie backup贸w (np. max 5 z 3 miesicy), progresywn kompresj z u偶yciem borgbackup , automatyczne zadania, integracje z ansible, ntfy.sh, nic poza baz nie jest backupowane, gdy偶 z zao偶enia jest odtwarzalne z kodu 

borgbackup - deduplicating backup program. Optionally, it supports compression and authenticated encryption.


---

Klasyfikator

Transformator dziaajcy na osadzaniach s贸w w celu wydobycia informacji o mo偶liwym wykorzystywanym API endpoint dla wybranych zapyta dodawania danych.

Zrobiony jako osobny modu, ze wzgldu na zupenie oddzielny zestaw zale偶noci.

Wykorzystywane:
sentence-transformers - operacje na osadzeniach s贸w
scikit-learn - podzia zbioru danych i inne operacje czsto wykorzystywane w uczeniu maszynowym
numpy, torch - operacje na wektorach i macierzach
fastapi - wystawienie REST API
pydantic, typing - wzbogacenie dynamicznego Pythona o deklaracje typ贸w
uv - zarzdzanie zale偶nociami i rodowiskiem wykonawczym

---

Przepyw ruchu sieciowego od u偶ytkownik贸w kocowych:

U偶ytkownik czc si z serwerem DNS i pytajc o nazw domenow naszej strony otrzymuje adres serwera Cloudflare, kt贸ry su偶y do filtrowania niechcianego ruchu sieciowego (Web Application Firewall).
Nastpnie ruch jest przekazywany dalej do podsieci naszego serwera w Google Cloud Platform. Jest tam filtrowany przez firewall, kt贸ry zezwala na ruch tylko na okrelonych portach i dodatkowo ogranicza nadu偶ycia.
Co idzie dalej, do instancji serwera dziaajcego jako VMka na Google Cloud Platform dociera zapytanie od klienta. Jest ono interpretowane i przetwarzane przez Traefik pod wzgldem poprawnoci i w razie pomylnej interpretacji przekazywane do usugi downstream.
domylnie zapytania (/) id do frontendu, aby wywietli interfejs u偶ytkownika
/klasyfikator obsuguje api klasyfikatora intencji 
/api obsuguje backend aplikacji

Traefik - wykorzystywany jako HTTP reverse proxy
- pozwala na scentralizowanie wszystkich usug pod jedn domen i korzystanie ze cie偶ek zamiast port贸w
- automatyzuje pozyskiwanie zaufanych certyfikat贸w TLS do HTTPS dziki Let's Encrypt (zewntrzna usuga publiczna)
- izoluje usugi za proxy przed bezporednim ruchem zewntrznym i daje wicej mo偶liwoci w kwestii skalowalnoci, ma mo偶liwo rozszerzenia o filtry bazujce na zaufaniu

Frontend na tym etapie to zwyky serwer HTTP nginx, skonfigurowany do serwowania statycznych plik贸w HTML, CSS i JS, kt贸re s renderowane po stronie klienta.

Klasyfikator przetwarza 偶adanie na podstawie lokalnych danych i zwraca wynik.

Najciekawiej jest na backendzie. Po uwierzytelnieniu u偶ytkownika za pomoc dopasowania hashy danych uwierzytelniajcych do znajdujcych si w bazie danych i wygenerowaniu 2 token贸w JWT (kr贸tkotrwaego tokenu sesji oraz dugotrwaego tokenu odwie偶enia powiadcze) zapytania mog by kontynuowane. Wikszo zapyta dotyczy wywietlenia lub modyfikacji danych, co za tym idzie nasze 偶danie REST HTTP jest mapowane na odpowiednie zapytanie SQL do bazy danych PostgreSQL z u偶yciem adaptera DrizzleORM. W przypadku listingu i wywietlania szczeg贸贸w koni s pokazywane ich zdjcia, kt贸re s przechowywane i udostpniane przez Cloud Storage Bucket. Aby to si jednak stao musi zosta wygenerowany specjalny link tzw. signed URL, kt贸ry jest unikalnym odniesieniem do danego obiektu dla tego u偶ytkownika w tej sesji. Dodatkowo backend obsuguje r贸wnie偶 komunikacj z agentem LLM Gemini do zapyta o intencje operacji wstawienia skomponowanych w formie zapyta jzyka naturalnego od u偶ytkownika (backend proxuje zapytania do gemini). Finalnie backend wysya maile czc si z serwerem Google SMTP.

---


Mo偶liwa lista temat贸w:
- (INFRA) opis infrastruktury: konfiguracja ~sprztowa vmki, dysk贸w, bucket贸w z uzyciem terraform, przygotowanie zale偶noci i ustawie systemu operacyjnego z ansible, modularno i powtarzalno rodowiska uruchomieniowego z docker
- (NET) opis ruchu sieciowego end2end: dns i waf z cloudflare, reverse proxy traefik, firewall, podzia frontend - backend, komunikacja backchannel z zewntrznymi usugami (certy, mail, gemini), optymalizacja dostarczania z optimistic caching i pwa
- (GIT) opis dziaania potok贸w cigej integracji / cigego wdra偶ania z ansible i github actions, hostowanie repozytorium git monorepo, model wsp贸pracy nad kodem pull request i weryfikacja jakoci kodu z eslint i etapem kompilacji 
- (DATA) opis modelu danych i sposobu ich przechowywania, schemat bazy danych, g贸wne rodzaje zapyta, zapewnienia sp贸jnoci danych, spos贸b backupu, wsp贸dzielony model walidacji danych zod
- (INNE) ciekawe zagadnienia architektury: modularno za pomoc mikro usug, wsp贸dzielenie schematu danych i dostpnych funkcji API za pomoc RPC, optymalizacja koszt贸w staych do zera za wyjtkiem dns


---


Referencje:
- PWA:
  1. https://web.dev/explore/progressive-web-apps?hl=pl
  2. https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps
- RWD:
   1. https://developer.mozilla.org/en-US/docs/Learn_web_development/Core/CSS_layout/Responsive_Design
- HTML, CSS, JS
    1. https://pl.wikipedia.org/wiki/HTML
    2. https://pl.wikipedia.org/wiki/Kaskadowe_arkusze_styl%C3%B3w

- React: https://react.dev/
- React Router: https://reactrouter.com/home
- Typescript: https://www.typescriptlang.org/
- Vite: https://vite.dev/
- Zod: https://zod.dev/
- Nginx: https://nginx.org/
- Nginx chainguard (distroless): https://images.chainguard.dev/directory/image/nginx/overview
- Hono: https://hono.dev/
- DrizzleORM: https://orm.drizzle.team/
- Borgmatic: https://torsion.org/borgmatic/
- Borgbackup: https://borgbackup.readthedocs.io/en/stable/
- Traefik: https://doc.traefik.io/traefik/

